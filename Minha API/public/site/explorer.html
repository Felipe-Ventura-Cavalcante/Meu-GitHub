<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Explorer - SONAR</title>
    <link rel="stylesheet" href="css/styles_ex.css">
    <link rel="shortcut icon" href="assets/icon/favicon2.ico" type="image/x-icon">
</head>

<body>
    <div class="bar_lateral">
        <div class="bar_titulo">
            SONAR
        </div>
        <div class="bar_nome_user">
            <a href="perfil.html">
                <div class="div_nome_user" id="div_nome_user">
                    <img src="assets/imgs/perfil.svg" alt="">
                    NOME USER
                </div>
            </a>
        </div>
        <div class="bar_p_e">
            <a href="explorer.html">
                <img src="assets/imgs/casa_branco.svg" alt="">
                EXPLORER
            </a>
        </div>
        <div class="bar_new">
            <a href="newpost.html">
                <img src="assets/imgs/new.svg" alt="">
                NEW POST
            </a>
        </div>
        <div class="bar_new">
            <a href="">
                <img src="assets/imgs/estatistica.svg" alt="">
                ESTATÍSTICAS
            </a>
        </div>
        <div class="bar_sair">
            <button onclick="sair()">
                <img src="assets/imgs/sair.svg" alt="">
                SAIR
            </button>
        </div>
    </div>

    <div class="container" id="container">

        <div class="titulo_ex">
            Explorer
        </div>

    </div>
</body>

</html>
<script>
    window.onload = function () {
        container.innerHTML = `
        <div class="titulo_ex">
            <img src="assets/imgs/notas_mus_col.svg" alt="">
            Explorer
        </div>`

        // Para exibir o nome do usuario logado
        // utilizamos o dado da sessão do login
        var idUsuario = sessionStorage.ID_USUARIO
        var nomeUsuario = sessionStorage.NOME_USUARIO
        var email = sessionStorage.EMAIL_USUARIO
        var descricaoUsuario = sessionStorage.DESCRICAO_USUARIO
        var imagem_perfil_user = sessionStorage.IMAGEM_PERFIL

        div_nome_user.innerHTML = `<img src="assets/imgs/perfil.svg" alt="">
        <span>Olá, ${nomeUsuario}</span>`

        fetch("/explorer/listar")

            // Se a requisição der certo, pegue esses dados
            .then(res => res.json())

            // eu exibo os meus dados.json(res) em dados_post
            //    (res =>)
            .then(dados_post => {

                // agora eu posso fazer o que eu quiser com esses dados
                for (var i = 0; i < dados_post.length; i++) {

                    // Essa var vem como array com vários objetos
                    var post = dados_post[i]

                    // para usar cada ojetivo individualmente eu utilizo o nome da var "post". "nome do campo"
                    var nome = post.nome
                    var quem_postou = post.quem_postou
                    var idPost = post.idPost
                    var descricao = post.descricao
                    var imagem_post = post.imagem_post
                    var imagem_post_perfil = post.imagem_perfil

                    if (imagem_post === 'null') {
                        container.innerHTML += `
                    <div class="exibicao" id="exibicao">
                    <div class="post">

                        <div class="post_user" id="${quem_postou}">
                           <img src="../assets/imagens perfil/${imagem_post_perfil}" alt="imagem de Perfil do Usuario">
                            ${nome}
                        </div>

                        <div class ="botões_cc">
                            <div class="curtida">

                                <button onclick="curtida('${idPost}','${quem_postou}')">
                                    <div class="cond_curtida" id="condCurtida${idPost}">
                                        <img src="assets/imgs/coracao bordas vermelhas.png" alt="">
                                    </div>
                                </button>

                                <div class="qtd_curtida" id="qtd_curtida${idPost}"></div>

                        </div>

                        <div class="comentarios" id="comentarios${idPost}">

                                <button onclick="comentario('${idPost}', '${quem_postou}')">
                                    <div id="comentario_aberto${idPost}">
                                    <img src="assets/imgs/chat.svg" alt="comentário">
                                    </div>
                                </button>

                            </div>

                        </div>

                        <div class="desc_post">

                                <div class="desc_user">
                                    ${nome}
                                </div>
                                <div class="desc_txt">
                                    ${descricao}
                                </div>
                            </div>
                        </div>
                        
                            <div class="todos_com">
                            <div class="texto_comentario" id="div_texto_comentario${idPost}"></div>
                            </div>
                    </div>`
                    } else if (imagem_post.endsWith('.mp4')) {

                        container.innerHTML += `
                    <div class="exibicao" id="exibicao">
                    <div class="post">

                        <div class="post_user" id="${quem_postou}">
                           <img src="../assets/imagens perfil/${imagem_post_perfil}" alt="imagem de Perfil do Usuario">
                            ${nome}
                        </div>

                        <div class="img_post">
                            <video width="640" height="360" controls>
                            <source src="../assets/imagens dos posts/${imagem_post}" type="video/mp4">
                            Seu navegador não suporta a reprodução de vídeo.
                            </video>
                        </div>

                        <div class ="botões_cc">
                            <div class="curtida">

                                <button onclick="curtida('${idPost}','${quem_postou}')">
                                    <div class="cond_curtida" id="condCurtida${idPost}">
                                        <img src="assets/imgs/coracao bordas vermelhas.png" alt="">
                                    </div>
                                </button>

                                <div class="qtd_curtida" id="qtd_curtida${idPost}"></div>

                        </div>

                        <div class="comentarios" id="comentarios${idPost}">

                                <button onclick="comentario('${idPost}', '${quem_postou}')">
                                    <div id="comentario_aberto${idPost}">
                                    <img src="assets/imgs/chat.svg" alt="comentário">
                                    </div>
                                </button>

                            </div>

                        </div>

                        <div class="desc_post">

                                <div class="desc_user">
                                    ${nome}
                                </div>
                                <div class="desc_txt">
                                    ${descricao}
                                </div>
                            </div>
                        </div>
                        
                            <div class="todos_com">
                            <div class="texto_comentario" id="div_texto_comentario${idPost}"></div>
                            </div>
                    </div>`
                    } else {
                        container.innerHTML += `
                    <div class="exibicao" id="exibicao">
                    <div class="post">

                        <div class="post_user" id="${quem_postou}">
                           <img src="../assets/imagens perfil/${imagem_post_perfil}" alt="imagem de Perfil do Usuario">
                            ${nome}
                        </div>

                        <div class="img_post">
                            <img src="../assets/imagens dos posts/${imagem_post}" alt="">
                        </div>

                        <div class ="botões_cc">
                            <div class="curtida">

                                <button onclick="curtida('${idPost}','${quem_postou}')">
                                    <div class="cond_curtida" id="condCurtida${idPost}">
                                        <img src="assets/imgs/coracao bordas vermelhas.png" alt="">
                                    </div>
                                </button>

                                <div class="qtd_curtida" id="qtd_curtida${idPost}"></div>

                        </div>

                        <div class="comentarios" id="comentarios${idPost}">

                                <button onclick="comentario('${idPost}', '${quem_postou}')">
                                    <div id="comentario_aberto${idPost}">
                                    <img src="assets/imgs/chat.svg" alt="comentário">
                                    </div>
                                </button>

                            </div>

                        </div>

                        <div class="desc_post">

                                <div class="desc_user">
                                    ${nome}
                                </div>
                                <div class="desc_txt">
                                    ${descricao}
                                </div>
                            </div>
                        </div>
                        
                            <div class="todos_com">
                            <div class="texto_comentario" id="div_texto_comentario${idPost}"></div>
                            </div>
                    </div>`
                    }

                    qtd_curtida(idPost)
                }

                listarCurtida()
            })


    }

    // Lista de curtida
    function listarCurtida() {
        var idUsuario = sessionStorage.ID_USUARIO;

        fetch(`/listaCurtida/${idUsuario}`)
            .then(res => res.json())
            .then(lista_de_Curtida => {

                for (var cont_lista_curtida = 0; cont_lista_curtida < lista_de_Curtida.length; cont_lista_curtida++) {

                    var lista = lista_de_Curtida[cont_lista_curtida]

                    var post_da_curtida = lista.post_curtida
                    console.log(lista_de_Curtida)
                    console.log(post_da_curtida)

                    var div_cond_curtida = document.getElementById(`condCurtida${post_da_curtida}`)
                    div_cond_curtida.innerHTML = `<img src="assets/imgs/coração vermelho.png" alt="">`
                }
            })
            .catch((erro) => {

                console.log(erro)
            }
            )
    }

    // Função de adicionar curtida
    function curtida(idPost, quem_postou) {
        var idUsuario = sessionStorage.ID_USUARIO
        var quem_postouVar = quem_postou

        var div_cond_curtida = document.getElementById(`condCurtida${idPost}`)

        // Me responde um valor booleano = true ou false para eu verificar se está ou não curtido
        var curtida_coracao_vermelho = div_cond_curtida.innerHTML.includes(`<img src="assets/imgs/coração vermelho.png" alt="">`)

        // Se for true
        if (curtida_coracao_vermelho) {

            fetch(`/deletarCurtida/${idPost}`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                }, body: JSON.stringify({

                    idUsuarioServer: idUsuario,
                    idPostServer: idPost,
                })
            }).then((res) => {
                console.log(res)

                div_cond_curtida.innerHTML = `<img src="assets/imgs/coracao bordas vermelhas.png" alt="">`

                listarCurtida()
                qtd_curtida(idPost)
            })
        } else {

            fetch(`/curtida/${idPost}`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                }, body: JSON.stringify({

                    idUsuarioServer: idUsuario,
                    idPostServer: idPost,
                    quem_postouServer: quem_postouVar
                })
            }).then(res => res.json())
                .then(respostaCurtida => {

                    console.log(respostaCurtida)
                    console.log("Deu certo a curtida")

                    listarCurtida()
                    qtd_curtida(idPost)
                }).catch(erro => {

                    console.log(erro)
                })
        }
    }

    function qtd_curtida(idPost) {
        console.log(`Função qtdCuritda: ${idPost}`)

        fetch(`/qtdCurtida/${idPost}`)
            .then((res) => res.json())
            .then(quantidade_curtida => {

                var campo = quantidade_curtida[0]
                var qtd = campo.qtd

                var div_qtd = document.getElementById(`qtd_curtida${idPost}`)
                div_qtd.innerHTML = `${qtd} curtidas`
            })
    }

    // Função de listar comentário
    var contador_comentário = 0
    function comentario(idPost, quem_postou) {

        var div_comentario = document.getElementById(`comentario_aberto${idPost}`)
        var div = document.getElementById(`div_texto_comentario${idPost}`)

        // Seleciona todos os elementos HTML que tem essa classe
        var todasDivsComentario = document.getElementsByClassName("texto_comentario");
        for (var i = 0; i < todasDivsComentario.length; i++) {

            // Fecho todas as div de comentário que estão abertas
            todasDivsComentario[i].innerHTML = "";

            // estou pegando o numero do contador e colocando no id da minha div
            var idAtual = todasDivsComentario[i].id.replace("div_texto_comentario", "");
            // estou pegando a div específica que tem esse id
            var iconeComentario = document.getElementById(`comentario_aberto${idAtual}`);

            if (iconeComentario) {
                iconeComentario.innerHTML = `<img src="assets/imgs/chat.svg" alt="">`;
            }
        }


        if (contador_comentário == 0) {

            fetch(`/explorer/${idPost}`)
                .then((res) => res.json())
                .then(todos_os_comentarios => {

                    div.innerHTML = `
                    <div class="titulo_comentario1">
                        <img src="assets/imgs/comentario_ponto.svg" alt="">
                            Comentários (${todos_os_comentarios.length})
                    </div>
                    <div class="adicionar_comentario">

                        <div class="titulo_comentario">
                            Comentar
                        </div>
                        <textarea type="text" id="input_add_comentario" placeholder="Adicione um comentário"></textarea>
                            

                            <button onclick="enviar_comentario(${idPost}, ${quem_postou})" id="${quem_postou}">

                                <img src="assets/imgs/enviar.svg" alt="">

                            </button>

                        </div>`

                    if (todos_os_comentarios.length > 0) {

                        div_comentario.innerHTML = `<img src="assets/imgs/chat_branco.svg" alt="">`


                        for (var cont = 0; cont < todos_os_comentarios.length; cont++) {
                            var comentario = todos_os_comentarios[cont]
                            var txt_comentario = comentario.texto_comentario
                            var nome_quem_comentou = comentario.nome
                            var imagem_perfil_comentario = comentario.imagem_perfil

                            div.innerHTML += `
                    <div class="texto_dos_comentarios">

                        <div class="nome_quem_comentou">
                           <img src="../assets/imagens perfil/${imagem_perfil_comentario}" alt="">
                            ${nome_quem_comentou}
                        </div>

                        <div class="new_com">
                        ${txt_comentario}
                        </div>

                    </div>`
                        }
                    } else {
                        div_comentario.innerHTML = `<img src="assets/imgs/chat_branco.svg" alt="">`

                        div.innerHTML += `
                    <div class="texto_dos_comentarios"> 
                        Esse post não tem nenhum comentário
                    </div>`
                    }

                })

            contador_comentário++
        }
        else {
            div_comentario.innerHTML = `<img src="assets/imgs/chat.svg" alt="">`
            div.innerHTML = ``
            contador_comentário--
        }
    }

    // Função de Adicionar um novo comentário
    function enviar_comentario(idPost, quem_postou) {

        var novo_comentario = input_add_comentario.value
        var idUsuario = sessionStorage.ID_USUARIO
        var quem_postouVar = quem_postou

        fetch(`/novoComentario/${idPost}`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            // Transformo os dados em Json pois o servidor espera dados em JSON
            body: JSON.stringify({

                idUsuarioServer: idUsuario,
                idPostServer: idPost,
                novo_comentarioServer: novo_comentario,
                quem_postouServer: quem_postouVar
            })
        }).then(() => {
            console.log("Comentário enviado com sucesso")

            input_add_comentario.value = ""
            contador_comentário = 0
            comentario(idPost, quem_postou)
        }).catch(function (erro) {

            console.log("Erro ao adicionar comentario")
            console.log(erro)
        })
    }

    // função para finalizar sessão e voltar para a home
    function sair() {

        sessionStorage.clear()
        window.location = "../index.html"
    }
</script>