<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil - SONAR</title>
    <link rel="stylesheet" href="css/styles_perfil.css">
    <link rel="shortcut icon" href="assets/icon/favicon2.ico" type="image/x-icon">
</head>

<body>
    <div class="bar_lateral">
        <div class="bar_titulo">
            SONAR
        </div>
        <div class="bar_nome_user">
            <a href="perfil.html">
                <div class="div_nome_user" id="div_nome_user">
                    <img src="assets/imgs/perfil_branco.svg" alt="">
                </div>
            </a>
        </div>
        <div class="bar_p_e">
            <a href="explorer.html">
                <img src="assets/imgs/casa.svg" alt="">
                EXPLORER
            </a>
        </div>
        <div class="bar_new">
            <a href="newpost.html">
                <img src="assets/imgs/new.svg" alt="">
                NEW POST
            </a>
        </div>
        <div class="bar_e">
            <a href="">
                <img src="assets/imgs/estatistica.svg" alt="">
                ESTATÍSTICAS
            </a>
        </div>
        <div class="bar_sair">
            <button onclick="sair()">
                <img src="assets/imgs/sair.svg" alt="">
                SAIR
            </button>
        </div>
    </div>

    <div class="container" id="container">
        <div class="superior" id="superior">

        </div>

        <div class="posts_do_user">
            <div class="titulo_postagens">
                Postagens do usuario
            </div>
            <div class="exibicao_post" id="exibicao_post">

            </div>
        </div>
    </div>

</body>

</html>
<script>
    var emailUser = sessionStorage.EMAIL_USUARIO
    var nomeUser = sessionStorage.NOME_USUARIO
    var idUsuario = sessionStorage.ID_USUARIO
    var descricaoUser = sessionStorage.DESCRICAO_USUARIO
    var imagem_perfilUser = sessionStorage.IMAGEM_PERFIL
    window.onload = function () {


        div_nome_user.innerHTML = `<img src="assets/imgs/perfil_branco.svg" alt="">
        Olá, ${nomeUser}`

        superior.innerHTML = `
        <div class="imagem_perfil" id="imagem_perfil">
                <label for="foto" class="imagem_perfilcss">
    <input type="file" id="foto" oninput="enviar()">
    <span><img src="../assets/imagens perfil/${imagem_perfilUser}" alt=""></span>
</label>
            </div>
            <div class="info_perfil">
                <div class="nome_do_usuario">
                    ${nomeUser}
                </div>
                <div class="botao_editar">
                    <button onclick="editar()">
                        Editar descrição
                    </button>
                    <div id="div_editar">
                    </div>
                </div>
                <div class="descricao_do_perfil">
                    ${descricaoUser}
                </div>
            </div>
            `

        fetch(`/perfil/${idUsuario}`,)
            .then(res => res.json())

            .then(dados_post => {

                for (var contador = 0; contador < dados_post.length; contador++) {
                    var dados = dados_post[contador]
                    console.log(idUsuario)

                    var nomePost = dados.nome
                    var idPost = dados.idPost
                    var descricaoPost = dados.descricao
                    var imagemPost = dados.imagem_post
                    var quem_postou = dados.quem_postou

                    if (imagemPost.endsWith('.mp4')) {

                        exibicao_post.innerHTML += `
                    <div class="exibicao" id="exibicao">
                    <div class="post">

                        <div class="post_user" id="${quem_postou}">
                           <img src="../assets/imagens perfil/${imagem_perfilUser}" alt="">
                            ${nomePost}
                        </div>

                        <div class="img_post">
                            <video width="640" height="360" controls>
                            <source src="../assets/imagens dos posts/${imagemPost}" type="video/mp4">
                            Seu navegador não suporta a reprodução de vídeo.
                            </video>
                        </div>

                        <div class ="botões_cc">
                            <div class="curtida">

                                <button onclick="curtida('${idPost}','${quem_postou}')">
                                    <div class="cond_curtida" id="condCurtida${idPost}">
                                        <img src="assets/imgs/coracao bordas vermelhas.png" alt="">
                                    </div>
                                </button>

                                <div class="qtd_curtida" id="qtd_curtida${idPost}"></div>

                        </div>

                        

                        </div>

                        <div class="desc_post">

                                <div class="desc_user">
                                    ${nomePost}
                                </div>
                                <div class="desc_txt">
                                    ${descricaoPost}
                                </div>
                            </div>
                        </div>`
                    } else {
                        exibicao_post.innerHTML += `
                    <div class="exibicao" id="exibicao">
                    <div class="post">

                        <div class="post_user" id="${quem_postou}">
                           <img src="../assets/imagens perfil/${imagem_perfilUser}" alt="">
                            ${nomePost}
                        </div>

                        <div class="img_post">
                            <img src="../assets/imagens dos posts/${imagemPost}" alt="">
                        </div>

                        <div class ="botões_cc">
                            <div class="curtida">

                                <button onclick="curtida('${idPost}','${quem_postou}')">
                                    <div class="cond_curtida" id="condCurtida${idPost}">
                                        <img src="assets/imgs/coracao bordas vermelhas.png" alt="">
                                    </div>
                                </button>

                                <div class="qtd_curtida" id="qtd_curtida${idPost}"></div>

                        </div>

                        

                        </div>

                        <div class="desc_post">

                                <div class="desc_user">
                                    ${nomePost}
                                </div>
                                <div class="desc_txt">
                                    ${descricaoPost}
                                </div>
                            </div>
                        </div>`
                    }
                    qtd_curtida(idPost)
                }

                listarCurtida()

            }).catch((erro) => {
                console.log(erro)
            })


    }

    function atualizarInfo() {
        console.log(`Esse é o idUsuario: ${idUsuario}`)
        fetch(`/atualizarInfo/${idUsuario}`)
            .then(res => res.json())
            .then(info_atualizado => {

                var info = info_atualizado[0]

                sessionStorage.NOME_USUARIO = info.nome
                sessionStorage.DESCRICAO_USUARIO = info.descricao
                sessionStorage.IMAGEM_PERFIL = info.imagem_perfil
            })
    }

    function editar() {
        var descricaoUser = sessionStorage.DESCRICAO_USUARIO
        div_editar.innerHTML = `
        <input type="text" id="input_nova_desc" value="${descricaoUser}">
        <button onclick="update()">ENVIAR</button>`
    }

    function update() {
        var novaDesc = input_nova_desc.value
        var idUsuario = sessionStorage.ID_USUARIO

        fetch("/perfil/atualizarDesc", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                idUsuarioServer: idUsuario,
                descricaoServer: novaDesc
            })
        }).then(res => {
            if (!res.ok) {
                throw new Error("Erro ao cadastrar");
            }
            console.log(res)
            alert(`Descrição atualizada, atualize a página`)
            atualizarInfo()
        }).catch(erro => {
            console.log(erro)
            alert(`Limite de caracteres excedido`)
        })

        div_editar.innerHTML = ``
    }

    // Lista de curtida
    function listarCurtida() {
        var idUsuario = sessionStorage.ID_USUARIO;

        fetch(`/listaCurtida/${idUsuario}`)
            .then(res => res.json())
            .then(lista_deCurtida => {

                for (var cont_lista_curtida = 0; cont_lista_curtida < lista_deCurtida.length; cont_lista_curtida++) {

                    var lista = lista_deCurtida[cont_lista_curtida]

                    var post_da_curtida = lista.post_curtida
                    console.log(lista_deCurtida)
                    console.log(post_da_curtida)

                    var div_cond_curtida = document.getElementById(`condCurtida${post_da_curtida}`)
                    div_cond_curtida.innerHTML = `<img src="assets/imgs/coraação vermelho.png" alt="">`
                }
            })
            .catch((erro) => {

                console.log(erro)
            }
            )
    }

    // Função de adicionar curtida
    function curtida(idPost, quem_postou) {
        var idUsuario = sessionStorage.ID_USUARIO
        var quem_postouVar = quem_postou

        var div_cond_curtida = document.getElementById(`condCurtida${idPost}`)

        // Me responde um valor booleano = true ou false para eu verificar se está ou não curtido
        var curtida_coracao_vermelho = div_cond_curtida.innerHTML.includes(`<img src="assets/imgs/coraação vermelho.png" alt="">`)

        // Se for true
        if (curtida_coracao_vermelho) {

            fetch(`/deletarCurtida/${idPost}`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                }, body: JSON.stringify({

                    idUsuarioServer: idUsuario,
                    idPostServer: idPost,
                })
            }).then((res) => {
                console.log(res)

                div_cond_curtida.innerHTML = `<img src="assets/imgs/coracao bordas vermelhas.png" alt="">`

                listarCurtida()
                qtd_curtida(idPost)
            })
        } else {

            fetch(`/curtida/${idPost}`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                }, body: JSON.stringify({

                    idUsuarioServer: idUsuario,
                    idPostServer: idPost,
                    quem_postouServer: quem_postouVar
                })
            }).then(res => res.json())
                .then(respostaCurtida => {

                    console.log(respostaCurtida)
                    console.log("Deu certo a curtida")

                    listarCurtida()
                    qtd_curtida(idPost)
                }).catch(erro => {

                    console.log(erro)
                })
        }
    }

    function qtd_curtida(idPost) {
        console.log(`Função qtdCuritda: ${idPost}`)

        fetch(`/qtdCurtida/${idPost}`)
            .then((res) => res.json())
            .then(quantidade_curtida => {

                var campo = quantidade_curtida[0]
                var qtd = campo.qtd

                var div_qtd = document.getElementById(`qtd_curtida${idPost}`)
                div_qtd.innerHTML = `${qtd} curtidas`
            })
    }

    function enviar() {

        var idUsuario = sessionStorage.ID_USUARIO

        if (
            !foto.value.endsWith(".png") &&
            !foto.value.endsWith(".jpeg") &&
            !foto.value.endsWith(".jpg") &&
            !foto.value.endsWith(".gif") &&
            !foto.value.endsWith(".webp") &&
            !foto.value.endsWith(".mp4") &&
            !foto.value.endsWith(".svg")) {

            alert(`Tipo de imagem não suportado`)

        } else {
            console.log(idUsuario, foto.files[0])

            const formData = new FormData()
            formData.append('foto', foto.files[0])
            formData.append('idUsuario', idUsuario)

            fetch("/fotoPerfil/enviarFoto", {
                method: "POST",
                body: formData
            }).then(res => {
                console.log(res)

                alert(`Imagem enviada, atualize a página`)
                atualizarInfo()
            }).catch(err => {
                console.log(erro)
            })
        }
    }

    function sair() {
        sessionStorage.clear()
        window.location = "../index.html"
    }
</script>