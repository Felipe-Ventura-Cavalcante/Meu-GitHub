<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Post - SONAR</title>
    <link rel="stylesheet" href="css/styles_newpost.css">
    <link rel="shortcut icon" href="assets/icon/favicon2.ico" type="image/x-icon">
</head>

<body>
    <div class="bar_lateral">
        <div class="bar_titulo">
            SONAR
        </div>
        <div class="bar_nome_user">
            <a href="perfil.html">
                <div class="div_nome_user" id="div_nome_user">
                    <img src="assets/imgs/perfil.svg" alt="">
                    NOME USER
                </div>
            </a>
        </div>
        <div class="bar_p_e">
            <a href="explorer.html">
                <img src="assets/imgs/casa.svg" alt="">
                EXPLORER
            </a>
        </div>
        <div class="bar_new">
            <a href="newpost.html">
                <img src="assets/imgs/new.svg" alt="">
                NEW POST
            </a>
        </div>
        <div class="bar_new">
            <a href="">
                <img src="assets/imgs/estatistica.svg" alt="">
                ESTATÍSTICAS
            </a>
        </div>
        <div class="bar_sair">
            <button onclick="sair()">
                <img src="assets/imgs/sair.svg" alt="">
                SAIR
            </button>
        </div>
    </div>

    <div class="container" id="container">
        <div class="card">

            <div class="titulo">
                Criar um novo post
            </div>

            <div class="add_arquivo">

                <div class="imagem" id="imagem_post">
                    <img src="assets/imgs/image.png" alt="">

                    <div class="txt_add_arquivo">
                        Adicione arquivos aqui
                    </div>

                </div>

                <!-- o label ele é uma etiqueta para a input que está invisivel
                 e o span é o texto dessas etiqueta -->
                <label class="botao_add" for="foto">
                    <span>Selecione o seu arquivo</span>
                    <input type="file" accept="image/*" name="foto" id="foto" oninput="exibir()">
                </label>

                <div class="desc">
                    <div class="txt_desc">
                        descrição
                    </div>
                    <textarea id="input_desc"></textarea>
                </div>
                <div class="tudo_certo" id="tudo_certo"></div>
            </div>

        </div>

        <div class="botao_enviar">
            <button onclick="enviar()">
                ENVIAR
            </button>
        </div>

    </div>
</body>

</html>
<script>
    window.onload = function () {

        var emailUser = sessionStorage.EMAIL_USUARIO
        var nomeUser = sessionStorage.NOME_USUARIO
        var idUsuario = sessionStorage.ID_USUARIO
        var descricaoUser = sessionStorage.DESCRICAO_USUARIO
        var imagem_perfilUser = sessionStorage.IMAGEM_PERFIL

        div_nome_user.innerHTML = `<img src="assets/imgs/perfil.svg" alt="">
        Olá, ${nomeUser}`
    }

    function exibir() {
        var arquivo = foto.files[0]; // pega o arquivo selecionado

        if (arquivo) {
            var leitor = new FileReader(); // cria um leitor de arquivos

            leitor.onload = function (evento) {
                imagem_post.innerHTML = `<img src="${evento.target.result}" alt="imagem escolhida">`;
            };

            leitor.readAsDataURL(arquivo); // lê o arquivo como uma URL de imagem (base64)
        }
    }

    function enviar() {
        console.log("Cheigeui na função")
        var idUsuario = sessionStorage.ID_USUARIO

        if (foto.value == `` ||
            input_desc.value == ``
        ) {
            tudo_certo.innerHTML = `Preecha todos os campos para enviar o post`

            setTimeout(() => {
                tudo_certo.innerHTML = ``
            }, 5000)
        } else if (
            !foto.value.endsWith(".png") &&
            !foto.value.endsWith(".jpeg") &&
            !foto.value.endsWith(".gif") &&
            !foto.value.endsWith(".webp") &&
            !foto.value.endsWith(".svg")) {

            tudo_certo.innerHTML = `Tipo de imagem não suportado`

            setTimeout(() => {
                tudo_certo.innerHTML = ``
            }, 5000)
        } else {


            console.log(idUsuario, foto.files[0], input_desc.value)
            const formData = new FormData()
            formData.append('foto', foto.files[0])
            formData.append('input_desc', input_desc.value)
            formData.append('idUsuario', idUsuario)

            fetch("/newPost/enviarPost", {
                method: "POST",
                body: formData
            }).then(res => {
                console.log(res)

                tudo_certo.innerHTML = `<p style="color: blue;">Post enviado com sucesso</p>`

                setTimeout(() => {
                    window.location = "explorer.html"
                }, 1000)

            }).catch(err => {
                console.log(erro)

            })
        }
    }

    // função para finalizar sessão e voltar para a home
    function sair() {

        sessionStorage.clear()
        window.location = "../index.html"
    }
</script>